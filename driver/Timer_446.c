//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// タイマー関係
// 2019.2.3 sakai created.
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#ifndef TIMER_446_C
#define TIMER_446_C

#include "Timer_446.h"

// =====================================================================================================================
//  TIM2の初期化と割り込み有効
// =====================================================================================================================
void TIM2_init() {
    // TIM2 clock enable on APB1
    RCC-> APB1ENR |= RCC_APB1ENR_TIM2EN;
    
    // timer counter settings PSC ARR 16bit 65536 
    TIM2->PSC = 44999; // APB1 / PSC  --- 45000000 / 45 = 1000000 -> 1MHz
    TIM2->ARR = 999;  // PSC / ARR
    TIM2->CNT = 0;  // ARR / CNT
}
// =====================================================================================================================
// TIM2 カウントsutart
// =====================================================================================================================
inline void TIM2_start(){
    // timer enable
    TIM2->CNT = 0;
    TIM2->CR1 |= TIM_CR1_CEN;
}

// =====================================================================================================================
// TIM2 カウント stop
// =====================================================================================================================
inline void TIM2_stop(){
    // timer enable
    TIM2->CR1 &= ~TIM_CR1_CEN;
    //TIM2->EGR = TIM_EGR_UG;
}
// =====================================================================================================================
// TIM2 ステータスレジスタ読み出し
// =====================================================================================================================
inline uint32_t TIM2_status(){
    return TIM2->SR;
}
// =====================================================================================================================
// TIM2 カウント読み出し
// =====================================================================================================================
inline uint32_t TIM2_read(){
    TIM2->CR1 &= ~TIM_CR1_CEN;
    return TIM2->CNT;
    
}

// =====================================================================================================================
// TIM2 Ticekr割り込みinit
// =====================================================================================================================
void TIM2_Tick_init(){
    // IRQ callback TIM2_IRQHandler()
    NVIC_SetPriority(TIM2_IRQn, 0);
    NVIC_EnableIRQ(TIM2_IRQn);

    // IRQ enable
    TIM2->DIER = TIM_DIER_UIE;
}

// =====================================================================================================================
// TIM2 Ticekr割り込まれ関数
// =====================================================================================================================
void TIM2_IRQHandler(void) {
    /* Your Code */
    
    static int flag = 0;
    
    flag =! flag;
    
    if( flag == 0 ) { 
        GPIOA->BSRR = 1 << 5; // PA5 LED On
    }
    else{
        GPIOA->BSRR = 1 << 21; // PA5 LED Off
    }
    /* End Your code */
    
    // IRQ flag clear
    TIM2->SR = ~TIM_SR_UIF;
}

#endif